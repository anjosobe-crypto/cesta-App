<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#2D6A4F">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="CestaApp">
<link rel="manifest" href="manifest.json">
<title>CestaApp ‚Äî Tu compra inteligente</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --cream:#FAF7F2;
  --cream2:#F2EDE4;
  --green:#2D6A4F;
  --green2:#40916C;
  --green3:#74C69D;
  --green4:#D8F3DC;
  --terra:#B5523F;
  --terra2:#E8A598;
  --gold:#D4A017;
  --gold2:#F5E6B3;
  --dark:#1A2E22;
  --mid:#4A6357;
  --light:#8BAD9A;
  --white:#FFFFFF;
  --shadow:0 4px 24px rgba(45,106,79,0.12);
  --shadow2:0 2px 8px rgba(45,106,79,0.08);
  --radius:16px;
  --radius2:10px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--dark);min-height:100vh;padding-bottom:80px;overflow-x:hidden}
h1,h2,h3{font-family:'Playfair Display',serif}

/* HEADER */
.app-header{background:var(--green);color:var(--cream);padding:16px 20px 12px;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(0,0,0,0.2)}
.header-row{display:flex;justify-content:space-between;align-items:center}
.app-title{font-size:1.4rem;font-weight:700;letter-spacing:-0.5px}
.app-title span{color:var(--green3)}
.header-budget{text-align:right}
.budget-label{font-size:0.7rem;opacity:0.7;text-transform:uppercase;letter-spacing:1px}
.budget-amount{font-size:1.1rem;font-weight:600}
.budget-bar-wrap{height:4px;background:rgba(255,255,255,0.2);border-radius:2px;margin-top:4px;width:120px}
.budget-bar{height:4px;border-radius:2px;background:var(--green3);transition:width .5s,background .5s}
.budget-bar.warn{background:var(--gold)}
.budget-bar.danger{background:var(--terra2)}

/* NAV */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--white);border-top:1px solid var(--cream2);display:flex;z-index:100;box-shadow:0 -4px 20px rgba(0,0,0,0.08)}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 4px;border:none;background:none;cursor:pointer;color:var(--light);font-size:0.6rem;font-family:'DM Sans',sans-serif;font-weight:500;text-transform:uppercase;letter-spacing:0.5px;transition:color .2s}
.nav-btn.active{color:var(--green)}
.nav-icon{font-size:1.4rem;margin-bottom:2px}

/* SECTIONS */
.section{display:none;padding:16px}
.section.active{display:block}

/* CARDS */
.card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow2);padding:16px;margin-bottom:12px}
.card-title{font-size:1rem;font-weight:700;color:var(--green);margin-bottom:12px;display:flex;align-items:center;gap:8px}

/* PRODUCT ITEM */
.product-item{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow2);padding:14px;margin-bottom:10px;border-left:4px solid var(--green3);position:relative;transition:transform .15s}
.product-item:active{transform:scale(0.98)}
.product-item.offer{border-left-color:var(--gold)}
.product-item.expensive{border-left-color:var(--terra)}
.pi-top{display:flex;justify-content:space-between;align-items:flex-start}
.pi-name{font-size:1rem;font-weight:600;color:var(--dark)}
.pi-brand{font-size:0.75rem;color:var(--light);margin-top:1px}
.pi-price{text-align:right}
.pi-total{font-size:1.1rem;font-weight:700;color:var(--green)}
.pi-unit{font-size:0.7rem;color:var(--light)}
.pi-bottom{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.tag{font-size:0.65rem;padding:2px 8px;border-radius:20px;font-weight:500}
.tag-cat{background:var(--green4);color:var(--green)}
.tag-store{background:var(--cream2);color:var(--mid)}
.tag-offer{background:var(--gold2);color:var(--gold)}
.tag-date{background:var(--cream2);color:var(--mid)}
.pi-actions{display:flex;gap:8px;margin-top:8px}
.btn-sm{border:none;border-radius:8px;padding:5px 12px;font-size:0.75rem;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:500}
.btn-edit{background:var(--green4);color:var(--green)}
.btn-del{background:#FEE2E2;color:var(--terra)}
.btn-history{background:var(--cream2);color:var(--mid)}

/* FORM */
.form-section{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:12px}
.form-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:var(--green);margin-bottom:16px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-group{display:flex;flex-direction:column;gap:4px}
.form-group.full{grid-column:1/-1}
.form-label{font-size:0.72rem;font-weight:600;color:var(--mid);text-transform:uppercase;letter-spacing:0.5px}
.form-input{border:2px solid var(--cream2);border-radius:var(--radius2);padding:10px 12px;font-family:'DM Sans',sans-serif;font-size:0.9rem;color:var(--dark);background:var(--cream);outline:none;transition:border .2s}
.form-input:focus{border-color:var(--green3)}
.form-input[type=checkbox]{width:20px;height:20px;cursor:pointer}
.checkbox-row{flex-direction:row;align-items:center;gap:10px;padding:8px 0}
.btn-primary{background:var(--green);color:var(--white);border:none;border-radius:var(--radius2);padding:14px 24px;font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:600;cursor:pointer;width:100%;margin-top:8px;transition:background .2s,transform .1s}
.btn-primary:active{transform:scale(0.98);background:var(--green2)}
.btn-secondary{background:var(--cream2);color:var(--mid);border:none;border-radius:var(--radius2);padding:12px 20px;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:500;cursor:pointer;transition:background .2s}
.btn-ocr{background:var(--terra);color:var(--white);border:none;border-radius:var(--radius2);padding:12px 20px;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;width:100%;justify-content:center;margin-bottom:12px}

/* ANALYTICS */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.stat-box{background:var(--white);border-radius:var(--radius);padding:14px;text-align:center;box-shadow:var(--shadow2)}
.stat-val{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;color:var(--green)}
.stat-lbl{font-size:0.7rem;color:var(--light);text-transform:uppercase;letter-spacing:0.5px;margin-top:2px}
.chart-wrap{background:var(--white);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow2);margin-bottom:12px}
.chart-title{font-size:0.85rem;font-weight:600;color:var(--mid);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px}
canvas{max-height:220px}

/* HISTORY */
.hist-item{background:var(--white);border-radius:var(--radius2);padding:12px;margin-bottom:8px;box-shadow:var(--shadow2)}
.hist-top{display:flex;justify-content:space-between}
.hist-product{font-weight:600;font-size:0.9rem}
.hist-price{font-weight:700;color:var(--green)}
.hist-meta{font-size:0.72rem;color:var(--light);margin-top:2px}
.price-trend{font-size:0.75rem;font-weight:600;padding:2px 6px;border-radius:6px}
.price-up{background:#FEE2E2;color:var(--terra)}
.price-down{background:var(--green4);color:var(--green)}
.price-same{background:var(--cream2);color:var(--mid)}

/* COMPARE TABLE */
.compare-table{width:100%;border-collapse:collapse;font-size:0.82rem}
.compare-table th{background:var(--green);color:var(--white);padding:8px 10px;text-align:left;font-weight:500}
.compare-table td{padding:8px 10px;border-bottom:1px solid var(--cream2)}
.compare-table tr:nth-child(even) td{background:var(--cream)}
.best-price{color:var(--green);font-weight:700}
.worst-price{color:var(--terra)}

/* BUDGET */
.budget-circle-wrap{display:flex;justify-content:center;margin:20px 0}
.budget-circle{width:160px;height:160px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:conic-gradient(var(--green) 0deg, var(--green) var(--pct), var(--cream2) var(--pct));position:relative}
.budget-circle::after{content:'';position:absolute;inset:20px;border-radius:50%;background:var(--cream)}
.budget-inner{position:relative;z-index:1;text-align:center}
.budget-pct{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;color:var(--green)}
.budget-sub{font-size:0.7rem;color:var(--light)}
.budget-set{display:flex;gap:10px;align-items:flex-end}
.budget-set .form-input{flex:1}
.alert-badge{background:var(--terra2);color:var(--terra);border-radius:8px;padding:10px;font-size:0.85rem;font-weight:500;margin-top:8px;display:none}
.alert-badge.show{display:block}

/* SHOPPING LIST */
.list-item{background:var(--white);border-radius:var(--radius2);padding:12px;margin-bottom:6px;display:flex;align-items:center;gap:12px;box-shadow:var(--shadow2)}
.list-check{width:22px;height:22px;border:2px solid var(--green3);border-radius:6px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:background .15s}
.list-check.checked{background:var(--green);border-color:var(--green)}
.list-check.checked::after{content:'‚úì';color:white;font-size:0.8rem;font-weight:700}
.list-info{flex:1}
.list-name{font-weight:600;font-size:0.9rem}
.list-detail{font-size:0.72rem;color:var(--light)}
.low-stock-badge{font-size:0.65rem;background:var(--terra2);color:var(--terra);padding:2px 6px;border-radius:10px}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;display:none;align-items:flex-end}
.modal-overlay.open{display:flex}
.modal{background:var(--white);border-radius:20px 20px 0 0;padding:20px;width:100%;max-height:85vh;overflow-y:auto}
.modal-title{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;color:var(--green);margin-bottom:16px}
.modal-close{float:right;background:var(--cream2);border:none;border-radius:8px;padding:4px 10px;cursor:pointer;font-size:0.85rem}

/* PREDICT */
.predict-box{background:linear-gradient(135deg,var(--green),var(--green2));border-radius:var(--radius);padding:20px;color:var(--white);margin-bottom:12px}
.predict-amount{font-family:'Playfair Display',serif;font-size:2.5rem;font-weight:900;letter-spacing:-1px}
.predict-label{font-size:0.8rem;opacity:0.8;margin-bottom:4px}
.predict-tip{font-size:0.8rem;opacity:0.9;margin-top:12px;background:rgba(255,255,255,0.15);border-radius:8px;padding:10px}

/* BEST TIME */
.best-time-item{background:var(--white);border-radius:var(--radius2);padding:12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow2)}
.bt-info .bt-name{font-weight:600;font-size:0.9rem}
.bt-info .bt-store{font-size:0.72rem;color:var(--light)}
.bt-price{text-align:right}
.bt-low{font-size:1.1rem;font-weight:700;color:var(--green)}
.bt-avg{font-size:0.72rem;color:var(--light)}

/* FILTERS */
.filter-row{display:flex;gap:8px;overflow-x:auto;padding:4px 0 8px;scrollbar-width:none}
.filter-row::-webkit-scrollbar{display:none}
.filter-chip{border:2px solid var(--cream2);background:var(--white);border-radius:20px;padding:5px 14px;font-size:0.78rem;font-weight:500;cursor:pointer;white-space:nowrap;transition:all .15s;color:var(--mid)}
.filter-chip.active{background:var(--green);border-color:var(--green);color:var(--white)}

/* OCR Status */
.ocr-status{font-size:0.82rem;padding:8px;border-radius:8px;text-align:center;margin-top:8px}
.ocr-status.loading{background:var(--gold2);color:var(--gold)}
.ocr-status.done{background:var(--green4);color:var(--green)}
.ocr-status.error{background:#FEE2E2;color:var(--terra)}

/* EMPTY STATE */
.empty{text-align:center;padding:40px 20px;color:var(--light)}
.empty-icon{font-size:3rem;margin-bottom:8px}
.empty-text{font-size:0.9rem}

/* Notification */
.notif{position:fixed;top:70px;left:16px;right:16px;background:var(--dark);color:var(--white);padding:12px 16px;border-radius:var(--radius2);z-index:300;font-size:0.85rem;transform:translateY(-80px);opacity:0;transition:all .3s}
.notif.show{transform:translateY(0);opacity:1}

/* SECTION HEADER */
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.section-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:var(--dark)}
.month-selector{border:2px solid var(--cream2);border-radius:8px;padding:4px 8px;font-family:'DM Sans',sans-serif;font-size:0.82rem;color:var(--mid);background:var(--white);outline:none}

/* TABS within section */
.sub-tabs{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none}
.sub-tab{border:none;background:var(--cream2);border-radius:8px;padding:7px 14px;font-family:'DM Sans',sans-serif;font-size:0.78rem;font-weight:500;cursor:pointer;color:var(--mid);white-space:nowrap;transition:all .15s}
.sub-tab.active{background:var(--green);color:var(--white)}

/* Observations textarea */
textarea.form-input{resize:vertical;min-height:60px}

/* Price comparison bars */
.comp-bar-wrap{margin:4px 0}
.comp-bar-label{display:flex;justify-content:space-between;font-size:0.75rem;color:var(--mid);margin-bottom:2px}
.comp-bar{height:8px;background:var(--cream2);border-radius:4px;overflow:hidden}
.comp-bar-fill{height:100%;border-radius:4px;background:var(--green3);transition:width .6s}
.comp-bar-fill.best{background:var(--green)}
.comp-bar-fill.worst{background:var(--terra2)}

/* PWA install banner */
.install-banner{background:var(--green4);border:2px solid var(--green3);border-radius:var(--radius2);padding:12px;display:flex;align-items:center;gap:10px;margin-bottom:12px;cursor:pointer}
.install-banner.hidden{display:none}
.install-text{flex:1;font-size:0.82rem;color:var(--green)}
.install-text strong{display:block;font-weight:600}
.install-btn{background:var(--green);color:var(--white);border:none;border-radius:8px;padding:6px 12px;font-size:0.78rem;font-weight:600;cursor:pointer}
</style>
</head>
<body>

<!-- HEADER -->
<header class="app-header">
  <div class="header-row">
    <div>
      <div class="app-title">üõí Cesta<span>App</span></div>
    </div>
    <div class="header-budget" id="headerBudget">
      <div class="budget-label">Presupuesto</div>
      <div class="budget-amount" id="hBudgetAmt">‚Äî</div>
      <div class="budget-bar-wrap"><div class="budget-bar" id="hBudgetBar" style="width:0%"></div></div>
    </div>
  </div>
</header>

<!-- NOTIFICATION -->
<div class="notif" id="notif"></div>

<!-- INSTALL BANNER -->
<div id="installBanner" class="install-banner hidden" style="margin:12px 16px 0">
  <span style="font-size:1.5rem">üì±</span>
  <div class="install-text"><strong>Instalar CestaApp</strong>A√±adir a pantalla de inicio</div>
  <button class="install-btn" id="installBtn">Instalar</button>
</div>

<!-- SECTIONS -->

<!-- LISTA DE COMPRA -->
<div class="section active" id="sec-lista">
  <div style="padding-top:12px">
    <div class="section-header">
      <div class="section-title">Tu cesta</div>
      <select class="month-selector" id="monthFilter" onchange="renderLista()">
        <option value="all">Todos</option>
      </select>
    </div>
    <div class="filter-row" id="catFilters"></div>
    <div id="listaContainer"></div>
  </div>
</div>

<!-- A√ëADIR / OCR -->
<div class="section" id="sec-add">
  <div style="padding-top:12px">
    <div class="form-section">
      <div class="form-title">üì¶ Nuevo producto</div>
      <button class="btn-ocr" id="ocrBtn" onclick="startOCR()">
        <span>üì∑</span> Escanear ticket con c√°mara
      </button>
      <input type="file" id="ocrInput" accept="image/*" capture="environment" style="display:none" onchange="processOCR(this)">
      <div class="ocr-status" id="ocrStatus" style="display:none"></div>
      <div class="form-grid" id="productForm">
        <div class="form-group full">
          <label class="form-label">Producto *</label>
          <input class="form-input" id="fName" placeholder="Ej: Leche entera" required>
        </div>
        <div class="form-group">
          <label class="form-label">Marca</label>
          <input class="form-input" id="fBrand" placeholder="Ej: Hacendado">
        </div>
        <div class="form-group">
          <label class="form-label">Categor√≠a</label>
          <select class="form-input" id="fCat">
            <option>Frutas y verduras</option>
            <option>L√°cteos</option>
            <option>Carnes</option>
            <option>Pescados</option>
            <option>Panader√≠a</option>
            <option>Bebidas</option>
            <option>Limpieza</option>
            <option>Higiene</option>
            <option>Congelados</option>
            <option>Conservas</option>
            <option>Cereales</option>
            <option>Snacks</option>
            <option>Otros</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Cantidad</label>
          <input class="form-input" id="fQty" type="number" step="0.01" min="0" value="1" oninput="calcTotal()">
        </div>
        <div class="form-group">
          <label class="form-label">Unidad</label>
          <select class="form-input" id="fUnit">
            <option>unidades</option>
            <option>kg</option>
            <option>g</option>
            <option>litros</option>
            <option>ml</option>
            <option>pack</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Precio unitario (‚Ç¨)</label>
          <input class="form-input" id="fPrice" type="number" step="0.01" min="0" value="0" oninput="calcTotal()">
        </div>
        <div class="form-group">
          <label class="form-label">Precio total (‚Ç¨)</label>
          <input class="form-input" id="fTotal" type="number" step="0.01" readonly style="background:var(--green4);font-weight:700;color:var(--green)">
        </div>
        <div class="form-group">
          <label class="form-label">Supermercado</label>
          <input class="form-input" id="fStore" placeholder="Ej: Mercadona" list="storeList">
          <datalist id="storeList"></datalist>
        </div>
        <div class="form-group">
          <label class="form-label">Fecha de compra</label>
          <input class="form-input" id="fDate" type="date">
        </div>
        <div class="form-group full checkbox-row">
          <input type="checkbox" class="form-input" id="fOffer">
          <label class="form-label" for="fOffer" style="text-transform:none;font-size:0.9rem;cursor:pointer">üè∑Ô∏è ¬øEst√° en oferta?</label>
        </div>
        <div class="form-group full">
          <label class="form-label">Observaciones</label>
          <textarea class="form-input" id="fNotes" placeholder="Notas adicionales..."></textarea>
        </div>
      </div>
      <button class="btn-primary" id="saveBtn" onclick="saveProduct()">üíæ Guardar producto</button>
      <button class="btn-secondary" id="cancelEdit" style="width:100%;margin-top:8px;display:none" onclick="cancelEdit()">Cancelar edici√≥n</button>
    </div>
  </div>
</div>

<!-- AN√ÅLISIS -->
<div class="section" id="sec-analytics">
  <div style="padding-top:12px">
    <div class="section-header">
      <div class="section-title">An√°lisis</div>
      <select class="month-selector" id="analyticsMonth" onchange="renderAnalytics()">
        <option value="all">Todos</option>
      </select>
    </div>
    <div class="stat-grid" id="statsGrid"></div>
    <div class="sub-tabs">
      <button class="sub-tab active" onclick="showAnalyticsTab('categories',this)">Por categor√≠a</button>
      <button class="sub-tab" onclick="showAnalyticsTab('evolution',this)">Evoluci√≥n</button>
      <button class="sub-tab" onclick="showAnalyticsTab('stores',this)">Supermercados</button>
      <button class="sub-tab" onclick="showAnalyticsTab('offers',this)">Ofertas</button>
    </div>
    <div id="analyticsContent"></div>
  </div>
</div>

<!-- HIST√ìRICO -->
<div class="section" id="sec-history">
  <div style="padding-top:12px">
    <div class="section-header">
      <div class="section-title">Hist√≥rico</div>
    </div>
    <div class="sub-tabs">
      <button class="sub-tab active" onclick="showHistoryTab('prices',this)">Precios</button>
      <button class="sub-tab" onclick="showHistoryTab('compare',this)">Comparativa</button>
    </div>
    <input class="form-input" id="histSearch" placeholder="üîç Buscar producto..." oninput="renderHistory()" style="margin-bottom:12px">
    <div id="historyContent"></div>
  </div>
</div>

<!-- PRESUPUESTO & PREDICCI√ìN -->
<div class="section" id="sec-budget">
  <div style="padding-top:12px">
    <div class="section-title" style="margin-bottom:14px">Presupuesto</div>
    <div class="card">
      <div class="card-title">üí∞ L√≠mite mensual</div>
      <div class="budget-set">
        <div style="flex:1">
          <div class="form-label">L√≠mite (‚Ç¨)</div>
          <input class="form-input" id="budgetInput" type="number" min="0" placeholder="Ej: 300">
        </div>
        <button class="btn-primary" style="width:auto;margin-top:0;padding:10px 16px" onclick="saveBudget()">Guardar</button>
      </div>
      <div class="alert-badge" id="budgetAlert">‚ö†Ô∏è ¬°Atenci√≥n! Llevas <span id="alertPct"></span>% del presupuesto este mes</div>
    </div>
    <div id="budgetCircleSection"></div>
    <div class="predict-box" id="predictBox">
      <div class="predict-label">Predicci√≥n de gasto mensual</div>
      <div class="predict-amount" id="predictAmt">‚Äî</div>
      <div class="predict-tip" id="predictTip"></div>
    </div>
    <div class="card">
      <div class="card-title">üïê Mejores momentos para comprar</div>
      <div id="bestTimeContent"></div>
    </div>
  </div>
</div>

<!-- LISTA AUTOM√ÅTICA -->
<div class="section" id="sec-autolist">
  <div style="padding-top:12px">
    <div class="section-header">
      <div class="section-title">Lista autom√°tica</div>
      <button class="btn-sm btn-edit" onclick="generateAutoList()">üîÑ Actualizar</button>
    </div>
    <div class="card" style="background:var(--green4);border:none">
      <div style="font-size:0.82rem;color:var(--green)">ü§ñ Basada en productos con compras recurrentes que no has comprado este mes, o marcados como escasos.</div>
    </div>
    <div id="autoListContainer"></div>
    <div style="margin-top:12px">
      <div class="section-title" style="font-size:1rem;margin-bottom:10px">‚úÖ Lista de hoy</div>
      <div id="todayListContainer"></div>
      <button class="btn-secondary" style="width:100%;margin-top:8px" onclick="clearChecked()">Limpiar marcados</button>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è Editar producto <button class="modal-close" onclick="closeModal()">‚úï Cerrar</button></div>
    <div id="modalContent"></div>
  </div>
</div>

<!-- HISTORY MODAL -->
<div class="modal-overlay" id="histModal">
  <div class="modal">
    <div class="modal-title" id="histModalTitle">Historial de precios <button class="modal-close" onclick="closeHistModal()">‚úï</button></div>
    <div id="histModalContent"></div>
    <canvas id="histModalChart" style="max-height:180px;margin-top:12px"></canvas>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-btn active" onclick="showSection('lista',this)">
    <span class="nav-icon">üõí</span>Lista
  </button>
  <button class="nav-btn" onclick="showSection('add',this)">
    <span class="nav-icon">‚ûï</span>A√±adir
  </button>
  <button class="nav-btn" onclick="showSection('analytics',this);renderAnalytics()">
    <span class="nav-icon">üìä</span>An√°lisis
  </button>
  <button class="nav-btn" onclick="showSection('history',this);renderHistory()">
    <span class="nav-icon">üìã</span>Hist√≥rico
  </button>
  <button class="nav-btn" onclick="showSection('budget',this);renderBudget()">
    <span class="nav-icon">üí∞</span>Presupuesto
  </button>
  <button class="nav-btn" onclick="showSection('autolist',this);generateAutoList()">
    <span class="nav-icon">üìù</span>Lista auto
  </button>
</nav>

<script>
// ==================== DATA ====================
let DB = JSON.parse(localStorage.getItem('cestaDB') || '{"products":[],"budget":0,"todayList":[]}');
let editingId = null;
let activeAnalyticsTab = 'categories';
let activeHistoryTab = 'prices';
let activeCatFilter = 'all';
let chartInstances = {};
let deferredPrompt = null;

function saveDB(){localStorage.setItem('cestaDB',JSON.stringify(DB))}

// ==================== PWA ====================
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredPrompt=e;
  document.getElementById('installBanner').classList.remove('hidden');
});
document.getElementById('installBtn').onclick=async()=>{
  if(deferredPrompt){await deferredPrompt.prompt();deferredPrompt=null;document.getElementById('installBanner').classList.add('hidden');}
};

// ==================== INIT ====================
function init(){
  setTodayDate();
  populateMonthFilters();
  renderCatFilters();
  renderLista();
  updateHeaderBudget();
  updateStoreList();
  checkReminders();
}

function setTodayDate(){
  document.getElementById('fDate').value = new Date().toISOString().split('T')[0];
}

function populateMonthFilters(){
  const months = [...new Set(DB.products.map(p=>p.date.substring(0,7)))].sort().reverse();
  ['monthFilter','analyticsMonth'].forEach(id=>{
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="all">Todos</option>';
    months.forEach(m=>{
      const d = new Date(m+'-01');
      const label = d.toLocaleDateString('es-ES',{month:'long',year:'numeric'});
      sel.innerHTML += `<option value="${m}">${label.charAt(0).toUpperCase()+label.slice(1)}</option>`;
    });
    // Set current month as default
    const cur = new Date().toISOString().substring(0,7);
    if(months.includes(cur)){sel.value=cur;}
  });
}

function updateStoreList(){
  const stores = [...new Set(DB.products.map(p=>p.store).filter(Boolean))];
  document.getElementById('storeList').innerHTML = stores.map(s=>`<option value="${s}">`).join('');
}

// ==================== NAV ====================
function showSection(name,btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  btn.classList.add('active');
}

// ==================== CALC ====================
function calcTotal(){
  const qty = parseFloat(document.getElementById('fQty').value)||0;
  const price = parseFloat(document.getElementById('fPrice').value)||0;
  document.getElementById('fTotal').value = (qty*price).toFixed(2);
}

// ==================== SAVE PRODUCT ====================
function saveProduct(){
  const name = document.getElementById('fName').value.trim();
  if(!name){showNotif('‚ö†Ô∏è El nombre del producto es obligatorio');return;}
  
  const product = {
    id: editingId || Date.now().toString(),
    name: name,
    brand: document.getElementById('fBrand').value.trim(),
    category: document.getElementById('fCat').value,
    qty: parseFloat(document.getElementById('fQty').value)||1,
    unit: document.getElementById('fUnit').value,
    priceUnit: parseFloat(document.getElementById('fPrice').value)||0,
    priceTotal: parseFloat(document.getElementById('fTotal').value)||0,
    store: document.getElementById('fStore').value.trim(),
    date: document.getElementById('fDate').value || new Date().toISOString().split('T')[0],
    offer: document.getElementById('fOffer').checked,
    notes: document.getElementById('fNotes').value.trim()
  };

  if(editingId){
    const idx = DB.products.findIndex(p=>p.id===editingId);
    DB.products[idx] = product;
    editingId = null;
    document.getElementById('cancelEdit').style.display='none';
    document.getElementById('saveBtn').textContent='üíæ Guardar producto';
  } else {
    DB.products.push(product);
  }
  
  saveDB();
  populateMonthFilters();
  updateStoreList();
  updateHeaderBudget();
  renderCatFilters();
  resetForm();
  showNotif('‚úÖ Producto guardado correctamente');
  showSection('lista',document.querySelectorAll('.nav-btn')[0]);
  renderLista();
}

function resetForm(){
  ['fName','fBrand','fStore','fNotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('fQty').value='1';
  document.getElementById('fPrice').value='0';
  document.getElementById('fTotal').value='0';
  document.getElementById('fOffer').checked=false;
  setTodayDate();
}

function cancelEdit(){
  editingId=null;
  resetForm();
  document.getElementById('cancelEdit').style.display='none';
  document.getElementById('saveBtn').textContent='üíæ Guardar producto';
}

function editProduct(id){
  const p = DB.products.find(x=>x.id===id);
  if(!p)return;
  editingId=id;
  document.getElementById('fName').value=p.name;
  document.getElementById('fBrand').value=p.brand||'';
  document.getElementById('fCat').value=p.category;
  document.getElementById('fQty').value=p.qty;
  document.getElementById('fUnit').value=p.unit;
  document.getElementById('fPrice').value=p.priceUnit;
  document.getElementById('fTotal').value=p.priceTotal;
  document.getElementById('fStore').value=p.store||'';
  document.getElementById('fDate').value=p.date;
  document.getElementById('fOffer').checked=p.offer;
  document.getElementById('fNotes').value=p.notes||'';
  document.getElementById('cancelEdit').style.display='block';
  document.getElementById('saveBtn').textContent='üíæ Actualizar producto';
  showSection('add',document.querySelectorAll('.nav-btn')[1]);
  window.scrollTo(0,0);
}

function deleteProduct(id){
  if(!confirm('¬øEliminar este producto?'))return;
  DB.products = DB.products.filter(p=>p.id!==id);
  saveDB();
  renderLista();
  populateMonthFilters();
  updateHeaderBudget();
  showNotif('üóëÔ∏è Producto eliminado');
}

// ==================== RENDER LISTA ====================
function renderCatFilters(){
  const cats = ['all',...new Set(DB.products.map(p=>p.category))];
  const catEmoji = {'Frutas y verduras':'ü•¶','L√°cteos':'ü•õ','Carnes':'ü•©','Pescados':'üêü','Panader√≠a':'ü•ñ','Bebidas':'ü•§','Limpieza':'üßπ','Higiene':'üß¥','Congelados':'‚ùÑÔ∏è','Conservas':'ü•´','Cereales':'üåæ','Snacks':'üçø','Otros':'üì¶'};
  document.getElementById('catFilters').innerHTML = cats.map(c=>`
    <button class="filter-chip ${c===activeCatFilter?'active':''}" onclick="setFilter('${c}')">
      ${c==='all'?'üõí Todo':(catEmoji[c]||'')+" "+c}
    </button>`).join('');
}

function setFilter(cat){
  activeCatFilter=cat;
  renderCatFilters();
  renderLista();
}

function renderLista(){
  const container = document.getElementById('listaContainer');
  const month = document.getElementById('monthFilter').value;
  
  let prods = [...DB.products].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(month !== 'all') prods = prods.filter(p=>p.date.startsWith(month));
  if(activeCatFilter !== 'all') prods = prods.filter(p=>p.category===activeCatFilter);
  
  if(prods.length===0){
    container.innerHTML=`<div class="empty"><div class="empty-icon">üõí</div><div class="empty-text">No hay productos. ¬°A√±ade tu primera compra!</div></div>`;
    return;
  }

  // Calculate avg prices to detect expensive items
  const avgPrices = {};
  DB.products.forEach(p=>{
    if(!avgPrices[p.name]) avgPrices[p.name]={sum:0,count:0};
    avgPrices[p.name].sum+=p.priceUnit; avgPrices[p.name].count++;
  });

  const total = prods.reduce((s,p)=>s+p.priceTotal,0);
  
  container.innerHTML = `<div style="font-size:0.82rem;color:var(--mid);margin-bottom:10px;font-weight:500">${prods.length} productos ¬∑ Total: <strong style="color:var(--green)">‚Ç¨${total.toFixed(2)}</strong></div>` +
    prods.map(p=>{
      const avg = avgPrices[p.name];
      const isExpensive = avg && avg.count>1 && p.priceUnit > (avg.sum/avg.count)*1.15;
      const cls = p.offer?'offer':(isExpensive?'expensive':'');
      return `<div class="product-item ${cls}">
        <div class="pi-top">
          <div>
            <div class="pi-name">${p.name}</div>
            <div class="pi-brand">${p.brand||''}</div>
          </div>
          <div class="pi-price">
            <div class="pi-total">‚Ç¨${p.priceTotal.toFixed(2)}</div>
            <div class="pi-unit">${p.qty} ${p.unit} ¬∑ ‚Ç¨${p.priceUnit.toFixed(2)}/u</div>
          </div>
        </div>
        <div class="pi-bottom">
          <span class="tag tag-cat">${p.category}</span>
          ${p.store?`<span class="tag tag-store">üè™ ${p.store}</span>`:''}
          ${p.offer?'<span class="tag tag-offer">üè∑Ô∏è Oferta</span>':''}
          ${isExpensive?'<span class="tag" style="background:#FEE2E2;color:var(--terra)">üìà Precio alto</span>':''}
          <span class="tag tag-date">${formatDate(p.date)}</span>
        </div>
        <div class="pi-actions">
          <button class="btn-sm btn-edit" onclick="editProduct('${p.id}')">‚úèÔ∏è Editar</button>
          <button class="btn-sm btn-history" onclick="showPriceHistory('${p.name}')">üìà Precios</button>
          <button class="btn-sm btn-del" onclick="deleteProduct('${p.id}')">üóëÔ∏è</button>
        </div>
        ${p.notes?`<div style="font-size:0.75rem;color:var(--light);margin-top:6px;border-top:1px solid var(--cream2);padding-top:6px">üìù ${p.notes}</div>`:''}
      </div>`;
    }).join('');
}

function formatDate(d){
  if(!d)return '';
  return new Date(d+'T12:00:00').toLocaleDateString('es-ES',{day:'numeric',month:'short'});
}

// ==================== ANALYTICS ====================
function showAnalyticsTab(tab,btn){
  activeAnalyticsTab=tab;
  document.querySelectorAll('.sub-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderAnalyticsContent();
}

function getFilteredProds(){
  const month = document.getElementById('analyticsMonth').value;
  if(month==='all') return DB.products;
  return DB.products.filter(p=>p.date.startsWith(month));
}

function renderAnalytics(){
  const prods = getFilteredProds();
  const total = prods.reduce((s,p)=>s+p.priceTotal,0);
  const offerSaved = prods.filter(p=>p.offer).length;
  const avgTicket = prods.length>0 ? total/[...new Set(prods.map(p=>p.date))].length : 0;
  
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-box"><div class="stat-val">‚Ç¨${total.toFixed(0)}</div><div class="stat-lbl">Gasto total</div></div>
    <div class="stat-box"><div class="stat-val">${prods.length}</div><div class="stat-lbl">Productos</div></div>
    <div class="stat-box"><div class="stat-val">‚Ç¨${avgTicket.toFixed(0)}</div><div class="stat-lbl">Media por visita</div></div>
    <div class="stat-box"><div class="stat-val">${offerSaved}</div><div class="stat-lbl">En oferta</div></div>
  `;
  renderAnalyticsContent();
}

function renderAnalyticsContent(){
  const prods = getFilteredProds();
  const content = document.getElementById('analyticsContent');
  
  if(chartInstances.analytics){chartInstances.analytics.destroy();delete chartInstances.analytics;}
  
  if(activeAnalyticsTab==='categories'){
    const cats={};
    prods.forEach(p=>{cats[p.category]=(cats[p.category]||0)+p.priceTotal;});
    const sorted=Object.entries(cats).sort((a,b)=>b[1]-a[1]);
    const colors=['#2D6A4F','#40916C','#74C69D','#B5523F','#D4A017','#8BAD9A','#4A6357','#D8F3DC','#E8A598','#F5E6B3','#FAF7F2','#1A2E22','#B7E4C7'];
    content.innerHTML=`<div class="chart-wrap"><div class="chart-title">Gasto por categor√≠a</div><canvas id="catChart"></canvas></div>
      ${sorted.map((e,i)=>`<div class="comp-bar-wrap"><div class="comp-bar-label"><span>${e[0]}</span><span>‚Ç¨${e[1].toFixed(2)}</span></div><div class="comp-bar"><div class="comp-bar-fill ${i===0?'best':''}" style="width:${(e[1]/sorted[0][1]*100)}%;background:${colors[i%colors.length]}"></div></div></div>`).join('')}`;
    const ctx=document.getElementById('catChart').getContext('2d');
    chartInstances.analytics=new Chart(ctx,{type:'doughnut',data:{labels:sorted.map(e=>e[0]),datasets:[{data:sorted.map(e=>e[1]),backgroundColor:colors,borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{font:{family:'DM Sans',size:11},padding:10}}}}});

  }else if(activeAnalyticsTab==='evolution'){
    const monthly={};
    DB.products.forEach(p=>{const m=p.date.substring(0,7);monthly[m]=(monthly[m]||0)+p.priceTotal;});
    const sorted=Object.entries(monthly).sort((a,b)=>a[0].localeCompare(b[0]));
    content.innerHTML=`<div class="chart-wrap"><div class="chart-title">Evoluci√≥n del gasto mensual</div><canvas id="evoChart"></canvas></div>`;
    const ctx=document.getElementById('evoChart').getContext('2d');
    chartInstances.analytics=new Chart(ctx,{type:'line',data:{labels:sorted.map(e=>{const d=new Date(e[0]+'-01');return d.toLocaleDateString('es-ES',{month:'short',year:'2-digit'});}),datasets:[{label:'Gasto (‚Ç¨)',data:sorted.map(e=>e[1]),borderColor:'#2D6A4F',backgroundColor:'rgba(45,106,79,0.1)',tension:0.4,fill:true,pointBackgroundColor:'#2D6A4F',pointRadius:5}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>'‚Ç¨'+v}}}}});

  }else if(activeAnalyticsTab==='stores'){
    const stores={};
    prods.forEach(p=>{if(p.store)stores[p.store]=(stores[p.store]||0)+p.priceTotal;});
    const sorted=Object.entries(stores).sort((a,b)=>b[1]-a[1]);
    content.innerHTML=`<div class="chart-wrap"><div class="chart-title">Gasto por supermercado</div><canvas id="storeChart"></canvas></div>`;
    const ctx=document.getElementById('storeChart').getContext('2d');
    chartInstances.analytics=new Chart(ctx,{type:'bar',data:{labels:sorted.map(e=>e[0]),datasets:[{label:'‚Ç¨',data:sorted.map(e=>e[1]),backgroundColor:'#40916C',borderRadius:8}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>'‚Ç¨'+v}}}}});

  }else if(activeAnalyticsTab==='offers'){
    const offerProds=prods.filter(p=>p.offer);
    const normalProds=prods.filter(p=>!p.offer);
    content.innerHTML=`
      <div class="card"><div class="card-title">üè∑Ô∏è Productos en oferta</div>
      ${offerProds.length===0?'<div class="empty-text">No hay productos en oferta este per√≠odo</div>':offerProds.map(p=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--cream2)"><div><div style="font-weight:600;font-size:0.88rem">${p.name}</div><div style="font-size:0.72rem;color:var(--light)">${p.store||'Sin tienda'}</div></div><div style="text-align:right"><div style="font-weight:700;color:var(--green)">‚Ç¨${p.priceUnit.toFixed(2)}</div><div style="font-size:0.65rem;color:var(--gold)">üè∑Ô∏è Oferta</div></div></div>`).join('')}
      </div>
      <div class="card"><div class="card-title">üìà Precios m√°s altos registrados</div>
      ${getExpensiveProducts().slice(0,5).map(p=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--cream2)"><div style="font-weight:600;font-size:0.88rem">${p.name}</div><div style="font-weight:700;color:var(--terra)">‚Ç¨${p.maxPrice.toFixed(2)}</div></div>`).join('')}
      </div>`;
  }
}

function getExpensiveProducts(){
  const map={};
  DB.products.forEach(p=>{
    if(!map[p.name]||p.priceUnit>map[p.name].maxPrice) map[p.name]={name:p.name,maxPrice:p.priceUnit};
  });
  return Object.values(map).sort((a,b)=>b.maxPrice-a.maxPrice);
}

// ==================== HISTORY ====================
function showHistoryTab(tab,btn){
  activeHistoryTab=tab;
  document.querySelectorAll('#sec-history .sub-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderHistory();
}

function renderHistory(){
  const content = document.getElementById('historyContent');
  const q = document.getElementById('histSearch').value.toLowerCase();
  
  if(activeHistoryTab==='prices'){
    const prods = {};
    DB.products.forEach(p=>{
      if(!prods[p.name]) prods[p.name]=[];
      prods[p.name].push({date:p.date,price:p.priceUnit,store:p.store,offer:p.offer});
    });
    
    let entries = Object.entries(prods).filter(([name])=>!q||name.toLowerCase().includes(q));
    
    if(entries.length===0){content.innerHTML=`<div class="empty"><div class="empty-icon">üìã</div><div class="empty-text">No hay historial</div></div>`;return;}
    
    content.innerHTML = entries.map(([name,records])=>{
      records.sort((a,b)=>new Date(b.date)-new Date(a.date));
      const latest=records[0];
      const prev=records[1];
      let trend='same',trendTxt='=',trendCls='price-same';
      if(prev){
        if(latest.price>prev.price){trend='up';trendTxt=`‚ñ≤ +‚Ç¨${(latest.price-prev.price).toFixed(2)}`;trendCls='price-up';}
        else if(latest.price<prev.price){trend='down';trendTxt=`‚ñº -‚Ç¨${(prev.price-latest.price).toFixed(2)}`;trendCls='price-down';}
      }
      const min=Math.min(...records.map(r=>r.price));
      const max=Math.max(...records.map(r=>r.price));
      return `<div class="hist-item" onclick="showPriceHistory('${name}')">
        <div class="hist-top">
          <div class="hist-product">${name}</div>
          <div style="display:flex;align-items:center;gap:6px">
            <div class="hist-price">‚Ç¨${latest.price.toFixed(2)}</div>
            <span class="price-trend ${trendCls}">${trendTxt}</span>
          </div>
        </div>
        <div class="hist-meta">${records.length} registros ¬∑ M√≠n ‚Ç¨${min.toFixed(2)} ¬∑ M√°x ‚Ç¨${max.toFixed(2)} ¬∑ √öltimo: ${formatDate(latest.date)} ${latest.store?'@ '+latest.store:''}</div>
      </div>`;
    }).join('');
    
  }else{
    // COMPARATIVA entre supermercados
    const stores = [...new Set(DB.products.map(p=>p.store).filter(Boolean))];
    if(stores.length<2){content.innerHTML=`<div class="empty"><div class="empty-icon">üè™</div><div class="empty-text">Registra compras en al menos 2 supermercados para comparar</div></div>`;return;}
    
    const prodNames = [...new Set(DB.products.map(p=>p.name))].filter(n=>!q||n.toLowerCase().includes(q));
    const multiStore = prodNames.filter(name=>{
      const s=new Set(DB.products.filter(p=>p.name===name&&p.store).map(p=>p.store));
      return s.size>=2;
    });
    
    if(multiStore.length===0){content.innerHTML=`<div class="empty"><div class="empty-icon">üè™</div><div class="empty-text">No hay productos comprados en m√∫ltiples supermercados todav√≠a</div></div>`;return;}
    
    content.innerHTML = multiStore.map(name=>{
      const records = DB.products.filter(p=>p.name===name&&p.store);
      const storeAvgs={};
      records.forEach(r=>{
        if(!storeAvgs[r.store]) storeAvgs[r.store]={sum:0,count:0};
        storeAvgs[r.store].sum+=r.priceUnit; storeAvgs[r.store].count++;
      });
      const pairs = Object.entries(storeAvgs).map(([s,v])=>({store:s,avg:v.sum/v.count})).sort((a,b)=>a.avg-b.avg);
      const best=pairs[0],worst=pairs[pairs.length-1];
      return `<div class="card" style="margin-bottom:10px">
        <div style="font-weight:700;font-size:0.95rem;margin-bottom:10px">${name}</div>
        ${pairs.map((p,i)=>`<div class="comp-bar-wrap">
          <div class="comp-bar-label"><span ${i===0?'style="color:var(--green);font-weight:600"':i===pairs.length-1?'style="color:var(--terra)"':''}>${p.store} ${i===0?'üèÜ':i===pairs.length-1?'üí∏':''}</span><span>‚Ç¨${p.avg.toFixed(2)}</span></div>
          <div class="comp-bar"><div class="comp-bar-fill ${i===0?'best':i===pairs.length-1?'worst':''}" style="width:${(p.avg/worst.avg*100).toFixed(0)}%"></div></div>
        </div>`).join('')}
        <div style="font-size:0.75rem;color:var(--green);margin-top:6px">üí° Ahorro potencial: ‚Ç¨${(worst.avg-best.avg).toFixed(2)}/unidad comprando en ${best.store}</div>
      </div>`;
    }).join('');
  }
}

function showPriceHistory(name){
  const records = DB.products.filter(p=>p.name===name).sort((a,b)=>new Date(a.date)-new Date(b.date));
  document.getElementById('histModalTitle').textContent = `üìà ${name}`;
  document.getElementById('histModalContent').innerHTML = `
    <table class="compare-table" style="width:100%;margin-bottom:12px">
      <tr><th>Fecha</th><th>‚Ç¨/u</th><th>Tienda</th><th>Oferta</th></tr>
      ${records.map(r=>`<tr><td>${formatDate(r.date)}</td><td><strong>‚Ç¨${r.priceUnit.toFixed(2)}</strong></td><td>${r.store||'‚Äî'}</td><td>${r.offer?'üè∑Ô∏è':'‚Äî'}</td></tr>`).join('')}
    </table>`;
  
  if(chartInstances.histModal){chartInstances.histModal.destroy();}
  const ctx = document.getElementById('histModalChart').getContext('2d');
  chartInstances.histModal = new Chart(ctx,{
    type:'line',
    data:{
      labels:records.map(r=>formatDate(r.date)),
      datasets:[{
        label:'‚Ç¨/unidad',
        data:records.map(r=>r.priceUnit),
        borderColor:'#2D6A4F',
        backgroundColor:'rgba(45,106,79,0.1)',
        tension:0.3,fill:true,
        pointBackgroundColor:records.map(r=>r.offer?'#D4A017':'#2D6A4F'),
        pointRadius:6
      }]
    },
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>'‚Ç¨'+v}}}}
  });
  
  document.getElementById('histModal').classList.add('open');
}

function closeHistModal(){document.getElementById('histModal').classList.remove('open');}

// ==================== BUDGET ====================
function saveBudget(){
  DB.budget = parseFloat(document.getElementById('budgetInput').value)||0;
  saveDB();
  updateHeaderBudget();
  renderBudget();
  showNotif('üí∞ Presupuesto guardado');
}

function getCurrentMonthSpend(){
  const cur = new Date().toISOString().substring(0,7);
  return DB.products.filter(p=>p.date.startsWith(cur)).reduce((s,p)=>s+p.priceTotal,0);
}

function updateHeaderBudget(){
  const budget = DB.budget||0;
  const spent = getCurrentMonthSpend();
  const pct = budget>0?(spent/budget*100):0;
  document.getElementById('hBudgetAmt').textContent = budget>0?`‚Ç¨${spent.toFixed(0)}/‚Ç¨${budget.toFixed(0)}`:'Sin l√≠mite';
  const bar = document.getElementById('hBudgetBar');
  bar.style.width = Math.min(pct,100)+'%';
  bar.className = 'budget-bar'+(pct>=90?' danger':pct>=70?' warn':'');
}

function renderBudget(){
  const budget = DB.budget||0;
  const spent = getCurrentMonthSpend();
  const pct = budget>0?Math.min(spent/budget*100,100):0;
  
  if(budget>0) document.getElementById('budgetInput').value=budget;
  
  const deg = (pct/100*360).toFixed(0)+'deg';
  const color = pct>=90?'var(--terra)':pct>=70?'var(--gold)':'var(--green)';
  
  document.getElementById('budgetCircleSection').innerHTML = `
    <div class="budget-circle-wrap">
      <div class="budget-circle" style="--pct:${deg}">
        <div class="budget-inner">
          <div class="budget-pct" style="color:${color}">${pct.toFixed(0)}%</div>
          <div class="budget-sub">‚Ç¨${spent.toFixed(2)} gastado</div>
          ${budget>0?`<div class="budget-sub">de ‚Ç¨${budget.toFixed(2)}</div>`:''}
        </div>
      </div>
    </div>`;
  
  const alert = document.getElementById('budgetAlert');
  if(pct>=70&&budget>0){
    alert.classList.add('show');
    document.getElementById('alertPct').textContent=pct.toFixed(0);
    alert.style.background=pct>=90?'#FEE2E2':'var(--gold2)';
    alert.style.color=pct>=90?'var(--terra)':'var(--gold)';
  } else {
    alert.classList.remove('show');
  }
  
  // Prediction
  renderPrediction();
  renderBestTime();
}

function renderPrediction(){
  const today = new Date();
  const dayOfMonth = today.getDate();
  const daysInMonth = new Date(today.getFullYear(),today.getMonth()+1,0).getDate();
  const spent = getCurrentMonthSpend();
  const projected = dayOfMonth>0?(spent/dayOfMonth)*daysInMonth:0;
  const budget = DB.budget||0;
  
  document.getElementById('predictAmt').textContent = `‚Ç¨${projected.toFixed(2)}`;
  
  let tip = `Llevas ${dayOfMonth} d√≠as del mes. `;
  if(budget>0){
    const diff = projected-budget;
    if(diff>0) tip += `‚ö†Ô∏è Si sigues as√≠, superar√°s el presupuesto en ‚Ç¨${diff.toFixed(2)}.`;
    else tip += `‚úÖ Vas dentro del presupuesto. Te sobrar√°n ~‚Ç¨${Math.abs(diff).toFixed(2)}.`;
  } else {
    const monthly = {};
    DB.products.forEach(p=>{const m=p.date.substring(0,7);monthly[m]=(monthly[m]||0)+p.priceTotal;});
    const vals = Object.values(monthly);
    if(vals.length>=2){
      const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
      const diff = projected - avg;
      tip += diff>0?`üìä Comparado con tu media (‚Ç¨${avg.toFixed(0)}/mes), este mes parece m√°s alto.`:`üìä Por debajo de tu media habitual (‚Ç¨${avg.toFixed(0)}/mes). ¬°Bien!`;
    }
  }
  document.getElementById('predictTip').textContent = tip;
}

function renderBestTime(){
  const content = document.getElementById('bestTimeContent');
  const prods={};
  DB.products.forEach(p=>{
    if(!prods[p.name]) prods[p.name]=[];
    prods[p.name].push({price:p.priceUnit,date:p.date,store:p.store,offer:p.offer});
  });
  
  const results = Object.entries(prods).filter(([,r])=>r.length>=2).map(([name,records])=>{
    const min = records.reduce((a,b)=>a.price<b.price?a:b);
    const avg = records.reduce((s,r)=>s+r.price,0)/records.length;
    const minMonth = new Date(min.date+'T00:00:00').toLocaleDateString('es-ES',{month:'long'});
    return {name,minPrice:min.price,minStore:min.store,minMonth,avg,savings:(avg-min.price)};
  }).sort((a,b)=>b.savings-a.savings).slice(0,8);
  
  if(results.length===0){content.innerHTML=`<div style="font-size:0.82rem;color:var(--light)">Registra m√°s compras del mismo producto para ver an√°lisis de momentos.</div>`;return;}
  
  content.innerHTML = results.map(r=>`
    <div class="best-time-item">
      <div class="bt-info">
        <div class="bt-name">${r.name}</div>
        <div class="bt-store">${r.minStore||'Tienda desconocida'} ¬∑ ${r.minMonth}</div>
      </div>
      <div class="bt-price">
        <div class="bt-low">‚Ç¨${r.minPrice.toFixed(2)}</div>
        <div class="bt-avg">Media: ‚Ç¨${r.avg.toFixed(2)}</div>
        ${r.savings>0.05?`<div style="font-size:0.65rem;color:var(--green)">Ahorras ‚Ç¨${r.savings.toFixed(2)}</div>`:''}
      </div>
    </div>`).join('');
}

// ==================== AUTO LIST ====================
function generateAutoList(){
  const container = document.getElementById('autoListContainer');
  const prods={};
  DB.products.forEach(p=>{
    if(!prods[p.name]) prods[p.name]={name:p.name,category:p.category,unit:p.unit,dates:[],qty:[]};
    prods[p.name].dates.push(p.date);
    prods[p.name].qty.push(p.qty);
  });
  
  const curMonth = new Date().toISOString().substring(0,7);
  const boughtThisMonth = new Set(DB.products.filter(p=>p.date.startsWith(curMonth)).map(p=>p.name));
  
  const suggestions = Object.values(prods).filter(p=>{
    if(boughtThisMonth.has(p.name)) return false;
    const sorted = [...p.dates].sort();
    const last = new Date(sorted[sorted.length-1]+'T00:00:00');
    const daysSince = (Date.now()-last.getTime())/(1000*60*60*24);
    // Suggest if bought multiple times and not bought recently this month
    return p.dates.length>=2 && daysSince>14;
  }).sort((a,b)=>b.dates.length-a.dates.length).slice(0,15);
  
  if(suggestions.length===0){
    container.innerHTML=`<div class="empty"><div class="empty-icon">‚ú®</div><div class="empty-text">No hay sugerencias autom√°ticas por ahora</div></div>`;
  } else {
    container.innerHTML = `<div style="font-size:0.8rem;color:var(--mid);margin-bottom:10px">Productos recurrentes que no has comprado este mes:</div>` +
      suggestions.map(p=>`
        <div class="list-item">
          <span class="tag tag-cat" style="margin-right:4px">${p.category}</span>
          <div class="list-info">
            <div class="list-name">${p.name}</div>
            <div class="list-detail">Comprado ${p.dates.length}√ó ¬∑ √öltimo: ${formatDate(p.dates.sort()[p.dates.length-1])}</div>
          </div>
          <button class="btn-sm btn-edit" onclick="addToTodayList('${p.name}','${p.category}')">+ Lista</button>
        </div>`).join('');
  }
  
  renderTodayList();
}

function addToTodayList(name,cat){
  if(!DB.todayList) DB.todayList=[];
  if(DB.todayList.find(i=>i.name===name)){showNotif('Ya est√° en la lista');return;}
  DB.todayList.push({name,cat,checked:false,id:Date.now().toString()});
  saveDB();
  renderTodayList();
  showNotif(`‚úÖ ${name} a√±adido a la lista`);
}

function renderTodayList(){
  const container = document.getElementById('todayListContainer');
  if(!DB.todayList||DB.todayList.length===0){
    container.innerHTML=`<div style="font-size:0.82rem;color:var(--light);text-align:center;padding:12px">Lista vac√≠a. A√±ade productos desde arriba.</div>`;
    return;
  }
  container.innerHTML = DB.todayList.map(item=>`
    <div class="list-item">
      <div class="list-check ${item.checked?'checked':''}" onclick="toggleTodayItem('${item.id}')"></div>
      <div class="list-info">
        <div class="list-name" style="${item.checked?'text-decoration:line-through;opacity:0.5':''}">${item.name}</div>
        <div class="list-detail">${item.cat}</div>
      </div>
      <button class="btn-sm btn-del" onclick="removeTodayItem('${item.id}')">‚úï</button>
    </div>`).join('');
}

function toggleTodayItem(id){
  const item = DB.todayList.find(i=>i.id===id);
  if(item){item.checked=!item.checked;saveDB();renderTodayList();}
}
function removeTodayItem(id){
  DB.todayList=DB.todayList.filter(i=>i.id!==id);saveDB();renderTodayList();
}
function clearChecked(){
  DB.todayList=DB.todayList.filter(i=>!i.checked);saveDB();renderTodayList();
}

// ==================== OCR ====================
function startOCR(){
  document.getElementById('ocrInput').click();
}

async function processOCR(input){
  if(!input.files[0])return;
  const status = document.getElementById('ocrStatus');
  status.style.display='block';
  status.className='ocr-status loading';
  status.textContent='‚è≥ Procesando imagen con OCR...';
  
  try {
    // Dynamically load Tesseract
    if(!window.Tesseract){
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.3/tesseract.min.js');
    }
    
    const result = await Tesseract.recognize(input.files[0],'spa',{logger:m=>{if(m.status==='recognizing text')status.textContent=`‚è≥ ${Math.round(m.progress*100)}% procesado...`;}});
    
    const text = result.data.text;
    parseTicketText(text);
    status.className='ocr-status done';
    status.textContent='‚úÖ Ticket procesado. Revisa los campos rellenados.';
  } catch(e) {
    status.className='ocr-status error';
    status.textContent='‚ùå Error procesando imagen. Int√©ntalo de nuevo.';
  }
}

function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script');s.src=src;s.onload=resolve;s.onerror=reject;
    document.head.appendChild(s);
  });
}

function parseTicketText(text){
  const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
  // Try to extract store name (usually first lines)
  const stores=['mercadona','lidl','carrefour','aldi','dia','alcampo','eroski','consum','hipercor','el corte ingles'];
  const storeLine = lines.find(l=>stores.some(s=>l.toLowerCase().includes(s)));
  if(storeLine) document.getElementById('fStore').value = storeLine.substring(0,30);
  
  // Try to extract date
  const dateRx = /(\d{2})[\/\-](\d{2})[\/\-](\d{2,4})/;
  const dateLine = lines.find(l=>dateRx.test(l));
  if(dateLine){
    const m=dateLine.match(dateRx);
    if(m){
      const y=m[3].length===2?'20'+m[3]:m[3];
      document.getElementById('fDate').value=`${y}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`;
    }
  }
  
  // Try to find price (last number-looking item)
  const priceRx=/(\d+[,\.]\d{2})/g;
  const prices=[];
  text.replace(priceRx,(m,p)=>prices.push(parseFloat(p.replace(',','.'))));
  if(prices.length>0){
    document.getElementById('fPrice').value=prices[prices.length-1].toFixed(2);
    calcTotal();
  }
  
  // Try first non-store, non-date line as product name
  const skipWords=['total','iva','ticket','fecha','hora','efectivo','cambio','subtotal','precio'];
  const nameLine = lines.find(l=>l.length>2&&l.length<40&&!stores.some(s=>l.toLowerCase().includes(s))&&!skipWords.some(w=>l.toLowerCase().includes(w))&&!dateRx.test(l)&&!/^\d+$/.test(l));
  if(nameLine) document.getElementById('fName').value = nameLine.substring(0,40);
}

// ==================== NOTIFICATIONS ====================
function showNotif(msg){
  const n=document.getElementById('notif');
  n.textContent=msg;n.classList.add('show');
  setTimeout(()=>n.classList.remove('show'),2500);
}

function checkReminders(){
  const curMonth = new Date().toISOString().substring(0,7);
  const prods={};
  DB.products.forEach(p=>{
    if(!prods[p.name]) prods[p.name]={dates:[],count:0};
    prods[p.name].dates.push(p.date);
    prods[p.name].count++;
  });
  
  const missing = Object.entries(prods).filter(([name,data])=>{
    if(data.dates.some(d=>d.startsWith(curMonth))) return false;
    const last = new Date(data.dates.sort()[data.dates.length-1]+'T00:00:00');
    const days = (Date.now()-last.getTime())/(1000*60*60*24);
    return data.count>=3 && days>21;
  });
  
  if(missing.length>0){
    setTimeout(()=>showNotif(`üì¶ ${missing.length} producto(s) habitual(es) sin comprar este mes`),1000);
  }
}

// ==================== MODAL ====================
function closeModal(){document.getElementById('editModal').classList.remove('open');}

// ==================== INIT ====================
init();
</script>
</body>
</html>
